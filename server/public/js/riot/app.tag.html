<app>
    <!--
    * Licensed under MIT License
    * Copyright (c) 2017 Bernhard GrÃ¼newaldt
    -->

    <!-- HTML -->
    <div class={ css.logoWrapper }>
        <img class={ css.logo } src="/img/logo-small.svg" />
    </div>

    <notification-bar notifications={ notifications }></notification-bar>

    <div class={ 'dropzone ' + css.dropzone } id="dropzonepng"></div>

    <div class={ css.files }>
        <file-status files={ items }></file-status>
    </div>

    <div class={ css.footer }>
        version { opts.appVersion } - crafted with SAUERKRAUT
    </div>

    <!-- JAVASCRIPT -->
    <script>
        //
        // FETCH HELPER METHODS
        //
        const fetchCheckStatus = (response) => {
            if (response.status >= 200 && response.status < 300) {
                return response
            } else {
                var error = new Error(response.statusText)
                error.response = response;
                throw error;
            }
        };
        const fetchParseJson = (response) => response.json();
        const fetchAddErrorToNotificationBar = (error) => {
            error.response.json().then((jsonError) => {
                console.log(jsonError);
                self.notifications.push(jsonError);
                self.update();
            });
        };

        //
        // METHODS
        //
        addFile(file) {
            self.items.push(file);
            file.status = 'compressing';
            self.update();
            fetch('/compress/lossless/' + file.uploadName + '/' + encodeURIComponent(file.originalName))
                .then(fetchCheckStatus)
                .then(fetchParseJson)
                .then((json) => {
                    file.status = 'done';
                    file.compressedSize = json.compressedSize;
                    file.downloadUrl = json.downloadUrl;
                    file.execResults =  json.execResults;
                    self.update();
                })
                .catch(fetchAddErrorToNotificationBar);
        }

        const onMount = () => {
            var myDropzone = new Dropzone("#dropzonepng", {
                url: "/upload",
                acceptedFiles: 'image/png,image/jpg,image/jpeg',
                dictDefaultMessage: 'Drop your PNG or JPG files here for lossless compression'
            });
            myDropzone.on("success", function(dropzoneFile, uploadResponse) {
                const file = {
                    thumbnailUri: null,
                    originalName: null,
                    originalType: null,
                    originalSize: null,
                    compressedSize: null,
                    downloadUrl: null,
                    execResults: [],
                    uploadName: null,
                    status: 'uploading'
                };
                file.thumbnailUri = dropzoneFile.previewElement.children[0].childNodes[0].src;
                file.originalName = dropzoneFile.name;
                file.originalType = dropzoneFile.type;
                file.originalSize = dropzoneFile.size;
                file.uploadName = uploadResponse.filename;
                file.status = 'uploaded';
                self.addFile(file);
                myDropzone.removeFile(dropzoneFile);
            });
        }

        //
        // STYLES
        //
        styles() {
            const styleProps = opts.felaMixin.mergeWithGlobalStyleProps({
                foo: 'red'
            });
            const styles = {
                dropzone: props => ({
                    border: '2px dashed ' + props.primaryColor,
                    borderRadius: '5px',
                    background: 'white',
                    margin: '40px',
                }),
                logoWrapper: props => ({
                    width: '100%',
                    marginTop: '60px',
                    marginBottom: '60px',
                    textAlign: 'center',
                }),
                logo: props => ({
                    height: '50px',
                }),
                files: props => ({
                    margin: '40px',
                }),
                footer: props => ({
                    width: '100%',
                    marginTop: '300px',
                    textAlign: 'center',
                    color: '#ccc',
                })
            };
            self.css = opts.felaMixin.renderAll(styles, styleProps);
        }



        //
        // INIT
        //
        const self = this;
        self.items = [];
        self.notifications = [];
        self.styles();
        self.on('mount', onMount);
    </script>

</app>