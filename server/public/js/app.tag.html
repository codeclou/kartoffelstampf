<app>
    <!--
    * Licensed under MIT License
    * Copyright (c) 2017 Bernhard GrÃ¼newaldt
    -->

    <!-- HTML -->
    <div class="app--logo-wrapper">
        <img class="app--logo" src="/img/logo-small.svg" />
    </div>

    <notification-bar notifications={ notifications }></notification-bar>

    <div class="dropzone" id="dropzonepng"></div>

    <div class="app--files">
        <file-status files={ items }></file-status>
    </div>

    <div class="app--footer">
        version { opts.appVersion } - crafted with SAUERKRAUT
    </div>

    <!-- JAVASCRIPT -->
    <script>
        var self = this;
        self.items = [];
        self.notifications = [];

        //
        // FETCH HELPER METHODS
        //
        const fetchCheckStatus = (response) => {
            if (response.status >= 200 && response.status < 300) {
                return response
            } else {
                var error = new Error(response.statusText)
                error.response = response;
                throw error;
            }
        };
        const fetchParseJson = (response) => response.json();
        const fetchAddErrorToNotificationBar = (error) => {
            error.response.json().then((jsonError) => {
                console.log(jsonError);
                self.notifications.push(jsonError);
                self.update();
            });
        };

        //
        // COMPONENT METHODS
        //
        addFile(file) {
            self.items.push(file);
            file.status = 'compressing';
            self.update();
            fetch('/compress/lossless/' + file.uploadName + '/' + encodeURIComponent(file.originalName))
                .then(fetchCheckStatus)
                .then(fetchParseJson)
                .then((json) => {
                    file.status = 'done';
                    file.compressedSize = json.compressedSize;
                    file.downloadUrl = json.downloadUrl;
                    file.execResults =  json.execResults;
                    self.update();
                })
                .catch(fetchAddErrorToNotificationBar);
        }

        self.on('mount', function() {
            var myDropzone = new Dropzone("#dropzonepng", {
                url: "/upload",
                acceptedFiles: 'image/png,image/jpg,image/jpeg',
                dictDefaultMessage: 'Drop your PNG or JPG files here for lossless compression'
            });
            const file = {
                thumbnailUri: null,
                originalName: null,
                originalType: null,
                originalSize: null,
                compressedSize: null,
                downloadUrl: null,
                execResults: [],
                uploadName: null,
                status: 'uploading'
            };
            myDropzone.on("success", function(file, uploadResponse) {
                file.thumbnailUri = file.previewElement.children["0"].childNodes["0"].currentSrc;
                file.originalName = file.name;
                file.originalType = file.type;
                file.originalSize = file.size;
                file.uploadName = uploadResponse.filename;
                file.status = 'uploaded';
                self.addFile(file);
                myDropzone.removeFile(file);
            });

        })
    </script>

    <!-- CSS -->
    <style scoped>
        .dropzone {
            border: 2px dashed #02A300;
            border-radius: 5px;
            background: white;
            margin:40px;
        }
        .app--logo-wrapper {
            width:100%;
            margin-top:60px;
            margin-bottom:60px;
            text-align: center;
        }
        .app--logo {
            height:50px;
            margin:auto;
        }
        .app--files {
            margin:40px;
        }
        .app--footer {
            width:100%;
            margin-top:300px;
            text-align:center;
            color: #ccc;
        }
    </style>

</app>